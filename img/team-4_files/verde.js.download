var pageLoaded = false;
var plyrControls = ['play', 'progress', 'mute', 'volume', 'fullscreen'];
var plyrSettings = ['captions', 'quality'];
var plyrFullscreen = { enabled: true, fallback: true, iosNative: false };
var scrollbarWidth = 0;

cssVars({
  onlyLegacy: true
});

var iOSvh = vhCheck({ cssVarName: 'ios-fix', force: true });

$(document).ready(function(){
	
	
	// web.app fix
    if(window.location.pathname == '/web.app'){
    	history.replaceState(null, null, '/home.web');
    }
	
	var $body = $("body");
	var $html = $("html");
	var body = document.body;
	var html = body.parentNode;
	var hasMouse = Modernizr.mousehover;
	var opacityEasing = "ease-in-out";
	var slideEasing = "easeInOutQuint";
	var human = false;
	var ajaxInProgress = false;
	var isAnimating = false;
	var animateBar = false;
	var windowWidth = $(window).width();
	var windowHeight = $(window).height();
	var scrollDuration = windowWidth < 768 ? 1200 : 800;
	var slideDuration = 800;
	var opacityDuration = 400;
	var colPad = getComputedStyle(document.body).getPropertyValue("--col-pad").replace("px","");
	var menuHeight = $('#bar').height();
	var menuTop = parseInt($('#bar').css('top'));
	var headerHeight = $("#main-header, #profile-header").last().outerHeight();
	var footerHeight = $("#footer").outerHeight();
	var initialLoad = true;
	var fixImg = false;
	var fixVideo = false;

	// Fixes

	if(bowser.ios || bowser.android)
		$html.addClass("viewport-fix");

	if(bowser.webkit || bowser.gecko)
		$html.addClass("nice-stroke");

	if(bowser.chrome || bowser.gecko)
		$html.addClass("fix-blur");

	/*if(bowser.msie || (bowser.msedge && bowser.version < 16))
	{
		fixImg = true;
		$html.addClass("fix-img-fit");
	}

	if(bowser.msie || bowser.msedge)
	{
		fixVideo = true;
		$html.addClass("fix-video-fit");
	}*/

	// Prevent AJAX caching

	$.ajaxSetup ({
	    cache: false
	});


	// Windows

	if(navigator.appVersion.indexOf("Win")!=-1)
	{
		$html.addClass("win");
	}


	// Get base URL for use in scripts

	var l = window.location;
	var baseURL = l.protocol + "//" + l.host;


	// Resize handler

	$.fn.resizeVideo = function() {
		return this.each(function() {

			var $obj = $(this);

			if(!$obj.data("ratio"))
			{
				var videoWidth = $obj.width();
				var videoHeight = $obj.height();

				$obj.data("ratio", videoWidth/videoHeight);
			}

			var parentWidth = $obj.parent().width();
			var parentHeight = $obj.parent().height();

			if($obj.data("ratio") < parentWidth/parentHeight)
				$obj.attr("style", "width: "+ parseFloat(parentHeight*$obj.data("ratio")*100/parentWidth).toPrecision(4) +"%; height: 100%");
			else
				$obj.removeAttr("style");
		});
	}

	handleResize = function(e){

		var resizeEvent = typeof e !== 'undefined' ? e : false;

		colPad = getComputedStyle(document.body).getPropertyValue("--col-pad").replace("px","");
		menuHeight = $('#bar').outerHeight();
		menuTop = parseInt($('#bar').css('top'));
		footerHeight = $("#footer").outerHeight();

		if(resizeEvent && pageLoaded)
			$html.addClass("resizing");

		windowWidth = $(window).width();
		windowHeight = $(window).height();

		if(hasMouse)
		{
			var $container = $("<div>").css({ height: 1, overflow: "scroll" }).appendTo("body");
			var $child = $("<div>").css({ height: 2 }).appendTo($container);

			scrollbarWidth = $container.width() - $child.width();
			$container.remove();
			$child.remove();

			if(scrollbarWidth)
				document.documentElement.style.setProperty("--scrollbar-width", scrollbarWidth + "px");
		}

		$(".plyr").resizeVideo();

		/*if(bowser.ios || bowser.android)
		{
			if($("#main-header").length && $("#main-header").is(".fullscreen") || $("#profile-header").length)
			{
				if(resizeEvent || initialLoad)
					headerHeight = $("#main-header, #profile-header").removeAttr("style").last().outerHeight();

				$("#main-header, #profile-header").removeAttr("style").attr("style", "height: "+ headerHeight +"px");
				if(($body.is(".home") || $body.is(".board") || windowWidth <= 1023) && !$body.is(".board-text-header"))
					$("#content").removeAttr("style").attr("style", "margin-top: "+ headerHeight +"px");
			}
			else
			{
				$("#content").removeAttr("style");
			}
		}*/

		initialLoad = false;

		if($("#map").length && placesMap)
		{
			placesMap.refresh();
			placesMap.setCenter(($("#map").data("lat")),$("#map").data("lng"));
		}

		setTimeout(function(){
			$html.removeClass("resizing");
		}, 150);
	}

	if(!("onorientationchange" in window))
  	{
		$(window).resize(function(e) {
	  		handleResize(true);
		});
  	}
  	else
  	{
  		$(window).on('orientationchange',function(e){
	        setTimeout(function(){
		        handleResize(true);
	        }, 100);
	    });
	}

	handleResize(false);


	// Scroll handler

	var scrollTop = window.pageYOffset;
	var prevScrollTop = scrollTop;
	var scrollBottom = body.scrollHeight - windowHeight - scrollTop;
	var fullsizeHeader = $(".fullscreen.full-bg").length;
	var mobileFullsizeHeader = $(".side-bg.fullscreen").length && windowWidth < 1024;
	var $headerVideo = $("header").find("video");
	var autoScroll = false;
	var $bars = $("#bar, #mobile-bar, #search-bar");

	if(scrollTop >= windowHeight - menuHeight)
		$html.addClass("fixed-bar");


	handleScroll = function()
	{
		scrollTop = window.pageYOffset;

	    if(prevScrollTop == scrollTop && pageLoaded)
        {
	        html.classList.remove("scrolling");

	        window.requestAnimationFrame(handleScroll);
			return false;
		}
		else
		{
			prevScrollTop = scrollTop;
			html.classList.add("scrolling");
			scrollBottom = body.scrollHeight - windowHeight - scrollTop;

			if(fullsizeHeader)
			{
				if(!ajaxInProgress && !isAnimating)
				{
					if(windowWidth >= 768)
					{
						if(scrollTop > windowHeight - (menuHeight + 2*menuTop) && scrollTop < windowHeight - menuHeight)
						{
								$bars.attr("style", "margin-top: -"+ (scrollTop - (windowHeight - menuHeight - 2*menuTop))/2 +"px");
						}
						else
							$bars.removeAttr("style");
					}
					else
					{
						$bars.removeAttr("style");
					}
				}

				if(scrollTop >= windowHeight - menuHeight)
					html.classList.add("fixed-bar");
				else
					html.classList.remove("fixed-bar");
			}
			else
			{
				if(windowWidth >= 768 && !ajaxInProgress && !isAnimating)
				{
					if(scrollTop && scrollTop < menuHeight)
						$bars.attr("style", "margin-top: -"+ scrollTop/2 +"px");
					else
						$bars.removeAttr("style");
				}

				if((scrollTop >= menuHeight && windowWidth > 1023) || ((scrollTop >= windowHeight - menuHeight || (($("#map").length || $body.is(".board-text-header")) && scrollTop > menuHeight)) && windowWidth <= 1023))
					html.classList.add("fixed-bar");

				else
					html.classList.remove("fixed-bar");
			}

			if(((fullsizeHeader || mobileFullsizeHeader) && scrollTop > windowHeight/3 || (!fullsizeHeader && !mobileFullsizeHeader)) && scrollBottom >= footerHeight)
				body.classList.add("visible-bottom-nav");
			else
				body.classList.remove("visible-bottom-nav");

			if((fullsizeHeader || windowWidth <= 1023) && scrollTop > windowHeight)
			{
				body.classList.add("hide-header");

				if($headerVideo.length && $headerVideo[0].playing)
					$headerVideo[0].pause();
			}
			else
			{
				body.classList.remove("hide-header");

				if($headerVideo.length && $headerVideo.attr("src") && !$headerVideo[0].playing)
					$headerVideo[0].play();
			}

			if(!autoScroll && document.getElementById("bottom-nav"))
				document.getElementById("bottom-nav").classList.remove("show-letters");

			// loop
			window.requestAnimationFrame(handleScroll);
		}
	}

	handleScroll();


	// Touch events
	if(!hasMouse)
	{
		var scrolling = false;

		/*if(bowser.ios || bowser.android)
			$body.on("touchstart", ".overlay", function(e){
			    if(!scrolling)
			    {
					scrolling = true;

				    if(e.currentTarget.scrollTop===0){
				        e.currentTarget.scrollTop = 1;
				    }else if(e.currentTarget.scrollHeight === e.currentTarget.scrollTop + e.currentTarget.offsetHeight){
				        e.currentTarget.scrollTop-=1;
				    }

				    scrolling = false;
				}

				console.log("start");
			});

		$body.on("touchmove", ".overlay", function(e) {
			if(bowser.ios || bowser.android)
				e.stopPropagation();
		});*/

		document.addEventListener("touchmove", function(e){

			if(($html.is(".menu-open") || $html.is(".overlay-open")) && (bowser.ios || bowser.android))
			{
				e.preventDefault();
			}

			isScrolling = true;
			//handleScroll();
		}, {passive: !bowser.ios && !bowser.android});

		document.addEventListener("touchend", function(e){
			isScrolling = true;
		});
	}


	// Menu

	$(document).on("click", "#burger, #mobile-burger", function(e){

		if(!isAnimating)
		{
			isAnimating = true;

			if(!$html.is(".menu-open"))
			{
				if(!$body.is(".board"))
					$("#boards").find(".open").removeClass("open");

				$("#mobile-burger").addClass("closeburger");

				$.Velocity.animate($("#menu-bg"), { opacity: .4 }, { visibility: "visible", duration: slideDuration, easing: slideEasing });
				$.Velocity.animate($("#menu"), { translateX: [-$("#menu").outerWidth(), 0], translateZ: 0 }, { visibility: "visible", duration: slideDuration, easing: slideEasing }).then(function(){
					$html.addClass("menu-open");
					$("#menu, #menu-bg").removeAttr("style");
					isAnimating = false;
				});
			}
			else
			{
				$("#mobile-burger").removeClass("closeburger");

				$.Velocity.animate($("#menu-bg"), { opacity: 0 }, { visibility: "hidden", duration: slideDuration, easing: slideEasing });
				$.Velocity.animate($("#menu"), { translateX: [$("#menu").outerWidth(), 0], translateZ: 0 }, { visibility: "hidden", duration: slideDuration, easing: slideEasing }).then(function(){
					$html.removeClass("menu-open");
					$("#menu-bg, #menu").removeAttr("style");
					isAnimating = false;
				});
			}
		}
	});

	closeMenu = function(){
		if(!isAnimating)
		{
			isAnimating = true;
			$("#mobile-burger").removeClass("closeburger");

			$.Velocity.animate($("#menu-bg"), { opacity: 0 }, { visibility: "hidden", duration: slideDuration, easing: slideEasing });
			$.Velocity.animate($("#menu"), { translateX: [$("#menu").outerWidth(), 0], translateZ: 0 }, { visibility: "hidden", duration: slideDuration, easing: slideEasing }).then(function(){
				$html.removeClass("menu-open");
				$("#menu-bg, #menu").removeAttr("style");
				isAnimating = false;
			});
		}
	}

	$(document).on("click", "#close, #menu-bg", function(e){
		closeMenu();
	});


	// Scrolling galleries

	(function($) {
	 	$.fn.initSlider = function(options) {
			return this.each(function() {
				var defaults = {
	                draggable: true,
	                wrapAround: true,
	                freeScroll: true,
	                attraction: .08,
	                friction: .8
	            };

	            options = $.extend(defaults, options);

				var $obj = $(this);
				var $heading = $obj.prev(".grid").find("h2");


				// Duplicate slides if they don't cover the whole screen

				var sliderWidth = 0;

				$obj.find("article").each(function(){
					sliderWidth += $(this)[0].scrollWidth;
				});

				if(sliderWidth < windowWidth*1.4)
				{
					var $slidesHTML = $obj.html();

					for(var i = 1; i <= Math.round(windowWidth*1.4 / sliderWidth); i++)
					{
						$obj.html($obj.html() + $slidesHTML);
					}
				}

				// Init flickity

				var $slider = $obj.flickity({
					cellSelector: 'article',
					cellAlign: ($heading.offset().left - colPad)/windowWidth,
					pageDots: false,
					draggable: !$obj.is(".showpack"),
					dragThreshold: 10,
					selectedAttraction: options.attraction,
					friction: options.friction,
					freeScrollFriction: 0.03,
					wrapAround: options.wrapAround,
					freeScroll: options.freeScroll,
					prevNextButtons: true
				});

				var flickity = $slider.data('flickity');
				var slides = flickity.cells;
				var currentIndex = flickity.selectedIndex;


				// Click-through to model profile

				$slider.on('staticClick.flickity', function( event, pointer, cellElement, cellIndex ) {
					if(!cellElement)
						return;

					if($obj.data("gallery"))
					{
						$body.addClass("loading");

						$('<div></div>').load($obj.data("gallery"), function(){
							$body.append($(this).children());
							$body.removeClass("loading")

							setTimeout(function(){
								var $clickedImg = $(cellElement).find("img");

								if($clickedImg.attr("data-src"))
									var clickedSrc = $clickedImg.attr("data-src");
								else
									var clickedSrc = $clickedImg.attr("src");

								var slideIndex = $("#overlay").find("img[data-src='"+ clickedSrc +"']").parents(".fullscreen").index();

								$("#overlay-slider").initOverlaySlider();

								//$("#overlay-slider").initOverlaySlider({ initialIndex: slideIndex });
								//$("#overlay").scrollTop($targerSlide.position().top);
								//$("#overlay-index").text(padZero(Math.round($("#overlay").scrollTop()/windowHeight) + 1));
							}, 0);

							openOverlay();
						});
					}
					else if($(cellElement).data("video"))
					{
						var parsedVideo = parseVideo($(cellElement).data("video"));
						var videoHTML = "";

						var $clickedImg = $(cellElement).find("img");

						if($clickedImg.attr("data-src"))
							var posterImg = $clickedImg.attr("data-src");
						else
							var posterImg = $clickedImg.attr("src");

						if(hasMouse)
							var autoplayString = "autoplay=1&amp;";
						else
							var autoplayString = "";

						if(parsedVideo.type == "youtube")
							videoHTML = '<div id="player" class="video-player plyr__video-embed"><iframe src="https://www.youtube.com/embed/'+ parsedVideo.id +'?'+ autoplayString +'mute=1&amp;iv_load_policy=3&amp;modestbranding=1&amp;playsinline=1&amp;showinfo=0&amp;rel=0&amp;enablejsapi=1&amp;origin='+ window.location +'" allowFullScreen webkitAllowFullScreen playsInline allow="autoplay"></iframe></div>';
						else if(parsedVideo.type == "vimeo")
								videoHTML = '<div id="player" class="video-player plyr__video-embed"><iframe src="https://player.vimeo.com/video/<'+ parsedVideo.id +'?'+ autoplayString +'muted=1&amp;loop=0&amp;byline=0&amp;portrait=0&amp;title=0&amp;transparent=0&amp;gesture=media" allowFullScreen webkitAllowFullScreen playsInline allow="autoplay"></iframe></div>';
						else
							videoHTML = '<video id="player" poster="'+ posterImg +'" class="video-player" src="'+ $(cellElement).data("video") +'" playsinline muted data-object-fit="contain"></video>'

						$body.append('<div id="overlay" class="overlay video-overlay"><div class="fullscreen">'+ videoHTML +'</div></div><div id="overlay-bg" class="overlay-bg"></div>');

						setTimeout(function(){
							var $video = $("#player");
							var $holder = $("#overlay");
							var player = new Plyr("#player", { autoplay: hasMouse, muted: true, controls: plyrControls, settings: plyrSettings, fullscreen: plyrFullscreen, clickToPlay: true });
							$holder.data("player", player);

							player.on("ready", function(e){
								$holder.addClass("player-init");

								if(hasMouse)
									player.play();

								e.detail.plyr.volume = .3;

								if(!hasMouse)
									$holder.addClass("hide-poster");
							});

							if(hasMouse)
								$(player.elements.container).on("click", function(){
									$holder.addClass("has-played hide-poster");
								});
							else
								player.on("playing", function(e){
									$holder.addClass("has-played");
								});

							player.on("enterfullscreen", function(e){
								$html.addClass("fullscreen-video");
							});

							player.on("exitfullscreen", function(e){
								$html.removeClass("fullscreen-video");
							});

							$(player.elements.container).resizeVideo();
						}, 0);

						//Open

						openOverlay();
					}
				});

				openOverlay = function(){
					if(!isAnimating)
					{
						isAnimating = true;
						var tempScrollTop = scrollTop;

						$.Velocity.animate($("#overlay-bg"), { opacity: 1 }, { visibility: "visible", duration: slideDuration, easing: slideEasing });
							$.Velocity.animate($("#overlay"), { translateX: [-$("#overlay").width(), 0], translateZ: 0 }, { visibility: "visible", duration: slideDuration, easing: slideEasing }).then(function(){

								$html.addClass("overlay-open");

								setTimeout(function(){
									$(window).scrollTop(tempScrollTop);
								}, 50);

								$("#overlay").off("scroll");
								$("#overlay, #overlay-bg").removeAttr("style");
								isAnimating = false;

								$("#overlay").fixObjectFit();//.lazyLoad();


								/*if($("#overlay-index").length)
									$("#overlay").on("scroll", function(){
										$("#overlay-index").text(padZero(Math.round($("#overlay").scrollTop()/windowHeight) + 1));
									});*/
							});
					}
				}


				// Auto scrolling

				if($obj.is(".auto-scroll") && hasMouse)
				{
					var previousDate;

				    function step() {
				        if (typeof previousDate == 'undefined') { return; }

				        var date = new Date();
				        var diff = (date - previousDate) / 25; // increase value to slow down
				        previousDate = date;

				        flickity.x -= diff;
				        flickity.positionSlider();

				        requestAnimationFrame(step);
				    }

				    function play() {
				        if (typeof previousDate == 'undefined') {
				            previousDate = new Date();
				        }

				        requestAnimationFrame(step);
				    }

				    function pause() {
				        previousDate = undefined;
				    }

				    setTimeout(play, 1000);

				    $obj.on("mouseenter", function(){
					    pause();
				    });

				    $obj.on("mouseleave", function(){
					    play();
				    });
				}


				// iOS drag fix

				if(bowser.ios)
				{
					$slider.on( 'dragStart.flickity', function( event, pointer ) {
					    document.ontouchmove = function (e) {
					        e.preventDefault();
					    }
					});
					$slider.on( 'dragEnd.flickity', function( event, pointer ) {
					    document.ontouchmove = function (e) {
					        return true;
					    }
					});
				}


				// Load images

				$obj.lazyLoad();
			});
		}
	}(jQuery));


	// Init overlay galleries

	(function($) {
	 	$.fn.initOverlaySlider = function(options) {
			return this.each(function() {
				var defaults = {
	                initialIndex: 0,
	                wrapAround: true,
	                autoInterval: false,
	                attraction: .08,
	                friction: .9,
	                cellAlign: "left"
	            };

	            options = $.extend(defaults, options);

				var $obj = $(this);

				if(windowWidth < 768)
				{
					options.friction = .95;
					options.attraction = .15;
				}


				var $slider = $obj.flickity({
					cellSelector: '.fullscreen',
					cellAlign: options.cellAlign,
					pageDots: false,
					draggable: true,
					selectedAttraction: options.attraction,
					friction: options.friction,
					//initialIndex: options.initialIndex,
					autoPlay: options.autoInterval,
					wrapAround: options.wrapAround,
					groupCells: false,
					prevNextButtons: false,
					pauseAutoPlayOnHover: false,
					accessibility: false
				});


				var flkty = $slider.data('flickity');
				flkty.selectCell(options.initialIndex, false, true);

				var slides = flkty.slides;
				var currentSlides = flkty.selectedElements;

				// Update index

				$("#overlay-index").text(padZero(flkty.selectedIndex + 1));
				$("#overlay-total").text(padZero(flkty.slides.length));

				// Load initial images

				$(flkty.cells[flkty.selectedIndex].element).find("img").loadImage(function(){

					var adjCellElems = flkty.getAdjacentCellElements(1, flkty.selectedIndex);

					$(adjCellElems).find("img").loadImage();
				});

				// Handle slide change

				if(slides.length > 1)
					$slider.on('select.flickity', function() {

						var adjCellElems = flkty.getAdjacentCellElements(1, flkty.selectedIndex);
						$(adjCellElems).find("img").loadImage();

						currentSlides = flkty.selectedElements;
						$("#overlay-index").text(padZero(flkty.selectedIndex + 1));
					});


				// Handle click on desktop

				if(hasMouse)
				{
					var clicks = 0;

					$slider.on('staticClick.flickity', function(e, direction) {

						clicks += 1;

						if(clicks == 1)
						{
							var overlayWidth = $("#overlay").outerWidth();
							var prevX = windowWidth - overlayWidth;
							var nextX = prevX + overlayWidth/2;

							/*e.stopPropagation();
							e.preventDefault();*/

							if((e.clientX > prevX && e.clientX < nextX || direction == "left") && (flkty.cells[flkty.selectedIndex-1] || options.wrapAround))
							{
								$slider.flickity('previous');
							}
							else if((e.clientX >= nextX || direction == "right") && (flkty.cells[flkty.selectedIndex+1] || options.wrapAround))
							{
								$slider.flickity('next');
							}
						}

						setTimeout(function(){
							clicks = 0;
						}, 500);
					});

					$obj.on('mousemove', function(e) {
						if(e.clientX < windowWidth/2)
							$slider.addClass("prev-arrow").removeClass("next-arrow");
						else
							$slider.removeClass("prev-arrow").addClass("next-arrow");
					});

					$obj.on('mouseleave', function(e) {
						$slider.removeClass("prev-arrow next-arrow");
					});


					// Handle mouse wheel

					var noWheel = false;

					$slider.on("wheel", function(e){

						if(noWheel === false)
						{
							e.preventDefault();

							noWheel = true;

							if((e.deltaX < 0 || e.deltaY > 0) && (flkty.cells[flkty.selectedIndex-1] || options.wrapAround))
							{
								$slider.flickity('previous');
							}
							else if((e.deltaX > 0 || e.deltaY < 0) && (flkty.cells[flkty.selectedIndex+1] || options.wrapAround))
							{
								$slider.flickity('next');
							}

							setTimeout(function(){
								noWheel = false;
							}, slideDuration + 1000);
						}
					});
				}
			});
		}
	}(jQuery));


	closeOverlay = function(){
		if(!isAnimating)
		{
			isAnimating = true;

			if($("#overlay").data("player"))
				$("#overlay").data("player").pause();

			$.Velocity.animate($("#overlay-bg"), { opacity: 0 }, { visibility: "hidden", duration: slideDuration, easing: slideEasing });
			$.Velocity.animate($("#overlay"), { translateX: [$("#overlay").width(), 0], translateZ: 0 }, { visibility: "hidden", duration: slideDuration, easing: slideEasing }).then(function(){
				$html.removeClass("overlay-open");
				$("#overlay, #overlay-bg").unLoadImages().empty().remove();
				isAnimating = false;
			});
		}
	}

	$(document).on("click", "#overlay-bg", function(e){
		closeOverlay();
	});

	var $sliders = $(".slider");

	if($sliders.length)
	{
		$sliders.initSlider();
	}

	// Article link hover

	$(document).on("mouseenter", "article a", function(){
		$(this).parents("article").addClass("hovered");
	});

	$(document).on("mouseleave", "article a", function(){
		$(this).parents("article").removeClass("hovered");
	});


	// AJAX nav

	loadSection = function(targetHref){

		var delay = 0;

		if($html.is(".menu-open"))
		{
			closeMenu();
			delay = slideDuration;
		}

		setTimeout(function(){
			$body.addClass("loading");
			var toAnimate = "";
			animateBar = windowWidth >= 1024 && $html.is(".fixed-bar");

			if($("#profile-container").length)
				toAnimate = "#profile-container, #footer";
			else
				toAnimate = "#main-container, #footer";

			if(animateBar)
			{
				if(windowWidth >= 1024)
					toAnimate += ", #bar";
				else
					toAnimate += ", #mobile-bar";
			}

			$.Velocity.animate($(toAnimate), { opacity: [0, 1] }, { duration: opacityDuration, easing: opacityEasing, mobileHA: false }).then(function(){
				ajaxInProgress = true;

				$('<div></div>').load(targetHref + "?ajax=1 #main-container", function(response, status){

				    if(status !== "error")
				    {
					    var $newContent = $(this).children().addClass("invisible");
					    var targetTitle = $newContent.data("meta-title");

					    iOSvh = vhCheck({ cssVarName: 'ios-fix', bind: false, force: true });

					    $("#main-container, #profile-container").unLoadImages().empty().remove();

					    $body.attr("class", $newContent.data("body-class"));
					    $("#footer").before($newContent.prop('outerHTML'));

						fullsizeHeader = $("#main-container").find(".fullscreen.full-bg").length;
						mobileFullsizeHeader = $("#main-container").find(".side-bg.fullscreen").length && windowWidth < 1024;
						$headerVideo = $("#main-header").find("video");
					    $(window).scrollTop(0);
					    $bars.removeAttr("style");

					    updateHistory("main", targetTitle, targetHref);
					    human = false;

					    // Init content

					    $("#main-container").find(".slider").initSlider();
					    handleResize(false);
					    addTargetBlank();

					    if($("#map").length && typeof(google) !== 'undefined')
							initplacesMap();
					    
						// Show AZ toggle
						
						if($("#az-toggle").length && !fullsizeHeader)
						{
							document.body.classList.add("visible-bottom-nav");
						}

						
						/*if($("#add-to-favorites").length && favouritesIDs.indexOf($("#add-to-favorites").data("id")) !== -1)
							$("#add-to-favorites").addClass("in-favorites");*/

						$("#main-header").fixObjectFit();
						$("#main-header, #thumbs").lazyLoad();

						fixDateInput();

						toAnimate = "#main-container, #footer";

						if(animateBar)
						{
							if(windowWidth >= 1024)
								toAnimate += ", #bar";
							else
								toAnimate += ", #mobile-bar";
						}

						$.Velocity.animate($(toAnimate), { opacity: [1, 0] }, { duration: opacityDuration, easing: opacityEasing, delay: 50, mobileHA: false }).then(function(){
							$(toAnimate).removeAttr("style").removeClass("invisible");
							ajaxInProgress = false;
							animateBar = false;
						});
					}
					else
					{
						ajaxInProgress = false;
						animateBar = false;
						$body.removeClass("loading");
					}

				    initializeFileUpload();
				});
			});


		}, delay);
	}

	loadProfile = function(targetHref){

		var delay = 0;

		if($html.is(".menu-open"))
		{
			closeMenu();
			delay = slideDuration;
		}
		else if($html.is(".search-open"))
		{
			closeSearch();
			delay = opacityDuration;
		}

		setTimeout(function(){
			$body.addClass("loading");

			if($("#main-container").length)
				var toAnimate = "#main-container, #footer";
			else
				var toAnimate = "#profile-container, #footer";

			animateBar = windowWidth >= 1024 && $html.is(".fixed-bar");

			if(animateBar)
			{
				if(windowWidth >= 1024)
					toAnimate += ", #bar";
				else
					toAnimate += ", #mobile-bar";
			}

			$.Velocity.animate($(toAnimate), { opacity: [0, 1] }, { duration: opacityDuration, easing: opacityEasing, mobileHA: false }).then(function(){
				ajaxInProgress = true;

				$('<div></div>').load(targetHref + "?ajax=1 #profile-container", function(response, status){

				    if(status !== "error")
				    {
					    var $newContent = $(this).children().addClass("invisible");
					    var targetTitle = $newContent.data("meta-title");

						iOSvh = vhCheck({ cssVarName: 'ios-fix', bind: false, force: true });

						if($("#main-container").length)
							$("#main-container").data("scroll-top", $(window).scrollTop());
						else
							$("#profile-container").unLoadImages().empty().remove();

						/*if($headerVideo.length && $headerVideo[0].playing)
							$headerVideo[0].pause();*/

						if($("#main-container").length)
					    	$body.attr("class", $newContent.data("body-class") + " ajax-profile");
					    else
					    	$body.attr("class", $newContent.data("body-class"));

					    $("#footer").before($newContent.prop('outerHTML'));
					    fullsizeHeader = $("#profile-container").find(".fullscreen.full-bg").length;
					    mobileFullsizeHeader = $("#profile-container").find(".side-bg.fullscreen").length && windowWidth < 1024;
					    $headerVideo = $("#profile-header").find("video");

					    $(window).scrollTop(0);
					    $bars.removeAttr("style");

					    updateHistory("profile", targetTitle, targetHref);
					    human = false;

					    // Init content

					    $("#profile-container").find(".slider").initSlider();
					    handleResize(false);
					    addTargetBlank();

						if(favouritesIDs.indexOf($("#add-to-favorites").data("id")) !== -1)
							$("#add-to-favorites").addClass("in-favorites");

						$("#profile-header").fixObjectFit().lazyLoad();

						toAnimate = "#profile-container, #footer";

						if(animateBar)
						{
							if(windowWidth >= 1024)
								toAnimate += ", #bar";
							else
								toAnimate += ", #mobile-bar";
						}

						$.Velocity.animate($(toAnimate), { opacity: [1, 0] }, { duration: opacityDuration, easing: opacityEasing, delay: 50, mobileHA: false }).then(function(){
							$(toAnimate).removeAttr("style").removeClass("invisible");
							ajaxInProgress = false;
							animateBar = false;
						});
					}
					else
					{
						ajaxInProgress = false;
						animateBar = false;
						$body.removeClass("loading");
					}
				});
			});
		}, delay);
	}

	closeProfile = function(targetHref){

		$body.addClass("loading");
		var toAnimate = "#profile-container";
		animateBar = windowWidth >= 1024 && ($html.is(".fixed-bar") && !$("#main-container").data("body-class") || !$html.is(".fixed-bar") && $("#main-container").data("body-class"));

		if(animateBar)
		{
			if(windowWidth >= 1024)
				toAnimate += ", #bar, #footer";
			else
				toAnimate += ", #mobile-bar, #footer";
		}

		$.Velocity.animate($(toAnimate), { opacity: [0, 1] }, { duration: opacityDuration, easing: opacityEasing, delay: 50, mobileHA: false }).then(function(){

		    $("#profile-container").unLoadImages().empty().remove();

		    $body.attr("class", $("#main-container").data("body-class"));
		    fullsizeHeader = $("#main-container").find(".fullscreen.full-bg").length;
		    mobileFullsizeHeader = $("#main-container").find(".side-bg.fullscreen").length && windowWidth < 1024;
		    $headerVideo = $("#main-header").find("video");

		    if(human)
		    {
		  		history.back();
		   	}

		   	var delay = 0;

		   	if($("#main-container").data("scroll-top"))
		   	{
		   		setTimeout(function(){
		   			$(window).scrollTop($("#main-container").data("scroll-top"));
		   		}, 50);
		   	}

		    // Init content

		    handleResize(false);

			toAnimate = "#main-container";

			if(animateBar)
			{
				if(windowWidth >= 1024)
					toAnimate += ", #bar, #footer";
				else
					toAnimate += ", #mobile-bar, #footer";
			}

			$.Velocity.animate($(toAnimate), { opacity: [1, 0] }, { duration: opacityDuration, easing: opacityEasing, delay: 100, mobileHA: false }).then(function(){
				$(toAnimate).removeAttr("style");
				ajaxInProgress = false;
				animateBar = false;
			});
		});
	}

	if(Modernizr.history)
	{
		$(document).on("click", "#boards a[href], #pages a, #footer-boards a[href], #footer-pages a, #logo, #mobile-logo, #favorites, .ajax-link", function(e){
			e.preventDefault();

			if(e.originalEvent)
	    	{
	    		human = true;
	    	}

			var $clicked = $(this);

			loadSection($clicked.attr("href"));
		});

		$(document).on("click", ".thumb:not(.letter), .caption a, #search-results a", function(e){
			e.preventDefault();

			if(e.originalEvent)
	    	{
	    		human = true;
	    	}

			var $clicked = $(this);

			if(!$clicked.is("a"))
				$clicked = $clicked.find("a").eq(0);

			loadProfile($clicked.attr("href"));
		});

		$(document).on("click", "#back, #mobile-back", function(e){
			e.preventDefault();

			if(e.originalEvent)
	    	{
	    		human = true;
	    	}

			var $clicked = $(this);

			closeProfile();
		});
	}
	else
	{
		$(document).on("click", ".has-link, .thumb", function(e){
			e.stopPropagation();

			var $link = $(this).find("a");

			if($link.length)
				window.location.href = $link.attr("href");
		});

		$(document).on("click", "#back, #mobile-back", function(e){
			e.preventDefault();

			history.back(-1);
		});
	}

	$(document).on("click", "#boards a:not([href])", function(e){
			e.preventDefault();

			var $clicked = $(this);
			var $childBoards = $clicked.next(".sub-boards");
			var $openBoard = $("#boards").find(".open");
			var delay = 0;

			if($openBoard.length)
			{
				$.Velocity.animate($openBoard, { height: 0, translateZ: 0 }, { duration: 250, easing: slideEasing }).then(function(){
					$openBoard.removeClass("open").removeAttr("style");
				});

				if($openBoard !== $childBoards)
					delay = 250;
			}

			if(!$childBoards.is(".open"))
			{
				var $firstChild = $childBoards.find("li").eq(0);
				$.Velocity.animate($childBoards, { height: [$firstChild[0].scrollHeight, 0], translateZ: 0 }, { duration: 250, easing: slideEasing, delay: delay }).then(function(){
					$childBoards.addClass("open").removeAttr("style");
				});
			}
		});

	updateHistory = function(type, title, href) {

		if(human && Modernizr.history)
		{
			var meta_title = window.siteTitle;
			var page_title = title;

			if(page_title !== "Home" && page_title !== meta_title && page_title)
				meta_title = page_title + " â€” " + meta_title;

			history.pushState({type: type, title: meta_title}, meta_title, href);

			if(typeof gtag == 'function' && window.analyticsID)
			{
				var trackUrl = href.replace(baseURL, "");

				gtag('config', window.analyticsID, {
				  'page_title': meta_title,
				  'page_path': trackUrl
				});
			}
		}
	}

	$(document).on("click", ".external, a[href^='mailto']", function(e){
		e.stopImmediatePropagation();
		e.stopPropagation();
	});

	// History navigation

	window.addEventListener('popstate', function(e) {
        var state = e.state;

        if(!human)
        {
			if(!ajaxInProgress)
			{
				var $historyLink = [];

				if($("#main-container").length && $("#profile-container").length)
					closeProfile();
				else if(e.state.type == "main")
					loadSection(location.href)
				else if(e.state.type == "profile")
					loadProfile(location.href)
				else
					window.location.reload();
			}
			else
			{
				window.location.reload();
			}
	    }
	    else
	    {
		    setTimeout(function(){
		    	human = false;
			}, 100);
		}
    });


    // Set initial state

     if(!history.state)
    {
		var title = document.title;

		if($body.is(".profile"))
			var type ="profile";
		else
			var type ="main";

		history.replaceState({type: type, title: title}, title, location.href);
	}


	// Scroll arrow

	$(document).on("click", "#scroll-down", function(e){
		e.preventDefault();

		var scrollTo = $("#main-header, #profile-header").last().outerHeight() - $("#bar").outerHeight();

		$.Velocity.animate($html, "scroll", { offset: scrollTo, duration: scrollDuration, easing: slideEasing, mobileHA: false }).then(function(){
			$("#scroll-down").removeClass("animate");
		});
	});


	// In-Profile nav

	$(document).on("click", "#profile-nav a", function(e){
		e.preventDefault();

		var scrollTo = $("#" + $(this).data("section")).offset().top;

		if(scrollTo)
			scrollTo += 50;

		$.Velocity.animate($html, "scroll", { offset: scrollTo, duration: scrollDuration, easing: slideEasing, mobileHA: false });
	});


	// A-Z bar

	$(document).on("click", "#az-toggle", function(e){
		$("#bottom-nav").toggleClass("show-letters");
	});

	$(document).on("click", "#letters a", function(e){
		var scrollEl = $("#thumbs").find(".box[data-letter='"+ $(this).attr("data-letter") +"']").eq(0);
		autoScroll = true;

		$.Velocity.animate($html, "scroll", { offset: Math.min(scrollEl.offset().top - menuHeight - colPad, $("#footer").offset().top - windowHeight - 2*colPad + $("#bottom-nav").outerHeight()), duration: scrollDuration/2, easing: slideEasing, mobileHA: false }).then(function(){
			setTimeout(function(){
				autoScroll = false;
			}, 150);
		});
	});


	// Make external links open in new window

	addTargetBlank = function(){

		$("a[rel=external], a[href^='mailto'], a[href^='http:']:not([href*='" + window.location.host + "']), a[href^='https:']:not([href*='" + window.location.host + "'])").each(function(){
			$(this).attr("target", "women");
		});
	}

	addTargetBlank();


	// Init MAP

	var placesMap;
	var mapLat;
	var mapLng;
	var latOffset;
	var placeIcon;

	var mapStyle=[{elementType:"labels.icon",stylers:[{visibility:"off"}]},{elementType:"labels.text.fill",stylers:[{color:"#444444"}]},{elementType:"labels.text.stroke",stylers:[{visibility:"off"}]},{featureType:"administrative",elementType:"geometry.stroke",stylers:[{saturation:-100},{lightness:40}]},{featureType:"administrative",elementType:"labels.text.fill",stylers:[{saturation:-100},{lightness:40}]},{featureType:"landscape",stylers:[{color:"#bbbbbb"}]},{featureType:"poi",stylers:[{visibility:"off"}]},{featureType:"road",stylers:[{saturation:-100},{lightness:40},{visibility:"simplified"}]},{featureType:"road",elementType:"geometry.fill",stylers:[{color:"#b1b1b1"}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"road.highway",stylers:[{visibility:"simplified"}]},{featureType:"transit",stylers:[{visibility:"off"}]},{featureType:"water",stylers:[{color:"#b1b9c9"},{visibility:"on"}]}];

	if(windowWidth <= 768)
	{
		var zoom = 15;
	}
	else
	{
		var zoom = 16;
	}

    initplacesMap = function(nearest){

	    mapLat = $("#map").data("lat");
		mapLng = $("#map").data("lng");
		placeIcon = {
			url: "data:image/svg+xml,%3Csvg width='34' height='34' viewBox='0 0 34 34' xmlns='http://www.w3.org/2000/svg'%3E%3Cg transform='translate(1 1)' stroke='%23111' stroke-width='2' fill='none' fill-rule='evenodd'%3E%3Ccircle fill-opacity='.45' fill='%23cccccc' cx='16' cy='16' r='16'/%3E%3Ccircle fill='%23111' cx='16' cy='16' r='2'/%3E%3C/g%3E%3C/svg%3E",
			size: new google.maps.Size(34, 34),
			origin: new google.maps.Point(0, 0),
			anchor: new google.maps.Point(17, 17),
			scaledSize: new google.maps.Size(34, 34)
		};

		var pinLat = mapLat;
		var pinLng = mapLng;

		if(windowWidth < 768)
			mapLat += 0.00095;

		placesMap = new GMaps({
			div: '#map',
			lat: mapLat,
			lng: mapLng,
			zoom: zoom,
			disableDefaultUI: true,
			mapTypeControl: false,
			overviewMapControl: false,
			panControl: false,
			scaleControl: false,
			streetViewControl: false,
			scrollwheel: !hasMouse,
			draggable: true,
			zoomControl: hasMouse,
			disableDoubleClickZoom: false,
			geocode: false,
			styles: mapStyle
	    });

	    var locationMarker = placesMap.createMarker({
			lat: pinLat,
			lng: pinLng,
			title: "",
			icon: placeIcon,
			optimized: false,
			shadow: null,
			setClickable: false
		});

		placesMap.addMarker(locationMarker);


		google.maps.event.addListener(placesMap.map, 'tilesloaded', function() {
		    $('#mapmap').find('img').attr('data-pin-nopin','nopin');
		});

		google.maps.event.addListener(placesMap.map, 'bounds_changed', function() {
		    $('#mapmap').find('img').attr('data-pin-nopin','nopin');
		});
	}

	if($("#map").length && typeof(google) !== 'undefined')
	{
		initplacesMap();
    }


    // Become form
	if(getAge($("#dob").val()) < 18){
		$("#parent-info").addClass("parent-visible");
		$("#parent-info input").prop("required", true);
	}

    checkAge = function(val){

		if(getAge(val) < 18)
		{
			$("#parent-info").addClass("parent-visible");
			$("#parent-info input").prop("required", true);
		}
		else
		{
			$("#parent-info").removeClass("parent-visible");
			$("#parent-info input").removeAttr("required");
		}

		$('#age').val(getAge(val));

    }

    fixDateInput = function(){
	    if(!Modernizr.inputtypes.date)
		{
			var script = document.createElement('script');
			script.onload = function() {
				if($("#dob").length)
				{
					$("#dob").attr("type", "text");
				    $("#dob").inputmask({
					    alias: "datetime",
					    inputFormat: "dd/mm/yyyy",
					    "clearIncomplete": true,
					    "oncomplete": function() {
						    var date = $("#dob").val().split("/");
						    checkAge(date[2] + "-" + date[1] + "-" + date[0]);
						    $("#formatted-dob").val(date[0] + "-" + date[1] + "-" + date[2]);
					    },
					    "onincomplete": function() {
						    $("#parent-info").removeClass("parent-visible");
							$("#parent-info input").removeAttr("required");
					    }
					});
			    }
			};

			script.src = $("script[src]").last().attr("src").split('?')[0].split('/').slice(0, -1).join('/') + '/jquery.inputmask.bundle.min.js';
			document.head.appendChild(script);
    	}
    }

    fixDateInput();


    if(Modernizr.inputtypes.date)
	    $(document).on("change keyup paste", "#dob", function(){
			checkAge($("#dob").val());

			var dob = new Date($("#dob").val());

			if(dob !== "Invalid Date" && !isNaN(dob))
			{
				var dd = dob.getDate();
				var mm = dob.getMonth() + 1;

				var yyyy = dob.getFullYear();
				if (dd < 10) {
				  dd = '0' + dd;
				}
				if (mm < 10) {
				  mm = '0' + mm;
				}

				$("#formatted-dob").val(dd + '-' + mm + '-' + yyyy);
			}
	});

	$(document).on("change keyup", "#uploads-field-1,#uploads-field-2,#uploads-field-3", function(){
		var $input = $(this);
		var filelist = this.files || [];
		var id = $input.attr("id").replace("uploads-field-", "");

		if(filelist.length)
		{
			var text = filelist[0].name;

			$("#uploads-wrapper-" + id).addClass("valid");
			$("#uploads-text-" + id).text(text);
		}
		else
		{
			$("#uploads-wrapper-" + id).removeClass("valid");
			$("#uploads-text-" + id).text($("#uploads-text-" + id).attr("data-text"));
		}
	});

	$(document).on("submit", "#become-form", function(e) {
    	e.preventDefault();

		// AJAX submission
		/*
		$.ajax({
			type: "POST",
			url: $("#become-form").attr("action"),
			data: $("#become-form").serialize(),
			success: function()
			{
			   $("#become-form").addClass("success");
			   $("#become-form button").html("Thank you!");
			}
		});
		*/
    });


	// Newsletter form

	$(document).on("submit", "#newsletter", function(e) {
    	e.preventDefault();

		// AJAX submission
		/*
		$.ajax({
			type: "POST",
			url: $("#newsletter").attr("action"),
			data: $("#newsletter").serialize(),
			success: function()
			{
			   $("#newsletter").addClass("success");
			   $("#newsletter input").val("").attr("placeholder", "Thank you!");
			}
		});
		*/
    });


	// Favourites

	var favouritesIDs = Cookies.get(window.websiteID + '_favouritesIDs');

	if(typeof favouritesIDs !== 'undefined')
	{
		// Init UI

		favouritesIDs = JSON.parse(favouritesIDs);

		$html.addClass("has-favorites");
		$("#favorites").attr("data-count", favouritesIDs.length);

		if($("#add-to-favorites").length && favouritesIDs.indexOf($("#add-to-favorites").data("id")) !== -1)
			$("#add-to-favorites").addClass("in-favorites");
	}
	else
	{
		favouritesIDs = [];
	}


	$(document).on("click", "#add-to-favorites", function(){
		var $clicked = $(this);

		if(favouritesIDs.indexOf($clicked.data("id")) == -1)
		{
			favouritesIDs.push($clicked.data("id"));
			Cookies.set(window.websiteID + '_favouritesIDs', favouritesIDs);

			$("#favorites").attr("data-count", favouritesIDs.length);
			$clicked.addClass("in-favorites pulse");
			$html.addClass("has-favorites");

			ui({action:'setFavourites',talentsIds:favouritesIDs.toString()});

		}
		else
		{
			favouritesIDs = favouritesIDs.filter(function(e) { return e !== $clicked.data("id") });
			$clicked.removeClass("in-favorites pulse");

			if(favouritesIDs.length)
			{
				$("#favorites").attr("data-count", favouritesIDs.length);
				Cookies.set(window.websiteID + '_favouritesIDs', favouritesIDs);
			}
			else
			{
				$("#favorites").removeAttr("data-count");
				Cookies.remove(window.websiteID + '_favouritesIDs');
				$html.removeClass("has-favorites");
			}

			ui({action:'setFavourites',talentsIds:favouritesIDs.toString()});
		}
	});


	// Search

	$(document).on("click", "#search, #mobile-search", function(e){
		e.preventDefault();

		if(!isAnimating)
		{
			isAnimating = true;
			$body.append("<div id='search-results' class='search-results'><div id='search-thumbs'></div></div>");

			if($body.is(".home"))
				var logoToAnimate = "#big-logo";
			else
				var logoToAnimate = "#logo";

			if(windowWidth < 768)
				logoToAnimate += ", #mobile-bar-menu";

			$.Velocity.animate($(logoToAnimate + ", #mobile-logo, #search, #mobile-search"), { opacity: 0 }, { duration: opacityDuration/2, easing: opacityEasing }).then(function(){
				$.Velocity.animate($("#search-bar"), { opacity: 1 }, { visibility: "visible", duration: opacityDuration/2, easing: opacityEasing });
			});

			$.Velocity.animate($("#search-results"), { opacity: 1 }, { visibility: "visible", duration: opacityDuration, easing: opacityEasing }).then(function(){
				isAnimating = false;
				$("#search-field").focus();
				$html.addClass("search-open");
				$(logoToAnimate + ", #mobile-logo, #search-bar, #search-results, #search, #mobile-search").removeAttr("style");
			});
		}
	});

	closeSearch = function(){
		if(!isAnimating)
		{
			isAnimating = true;

			if($body.is(".home"))
				var logoToAnimate = "#big-logo";
			else
				var logoToAnimate = "#logo";

			if(windowWidth < 768)
				logoToAnimate += ", #mobile-bar-menu";

			$.Velocity.animate($("#search-bar"), { opacity: 0 }, { duration: opacityDuration/2, easing: opacityEasing }).then(function(){
				$.Velocity.animate($(logoToAnimate + ", #mobile-logo, #search, #mobile-search"), { opacity: 1 }, { visibility: "visible", duration: opacityDuration/2, easing: opacityEasing });
			});

			$.Velocity.animate($("#search-results"), { opacity: 0 }, {duration: opacityDuration, easing: opacityEasing }).then(function(){
				isAnimating = false;
				$html.removeClass("search-open");
				$(logoToAnimate + ", #mobile-logo, #search-bar, #search, #mobile-search").removeAttr("style");
				$("#search-field").val("");
				$("#search-results").unLoadImages().empty().remove();
			});
		}
	}

	var searchTimeout;
	var lastSearch;

	doSearch = function(keyword){

		clearTimeout(searchTimeout);

		if(!$("#search-thumbs").is(".transitioned"))
		{
			$("#search-thumbs").addClass("transitioned");
			$.Velocity.animate($("#search-thumbs"), { opacity: 0 }, {duration: opacityDuration, easing: opacityEasing });
		}

		if(keyword.length >= 3)
		{
			searchTimeout = setTimeout(function(){
				$('<div></div>').load($("#search-bar").attr("action") + "?s=" + encodeURIComponent(keyword), function(){
					var $newContent = $(this);
					lastSearch = keyword;

					$("#search-thumbs").empty().append($newContent);
					$("#search-thumbs").removeClass("transitioned");

					$("#search-thumbs").lazyLoad();

					$.Velocity.animate($("#search-thumbs"), { opacity: 1 }, {duration: opacityDuration, easing: opacityEasing });
				});
			}, 400);
		}
	}

	$(document).on("submit", "#search-field", function(e){
		e.preventDefault();
	});

	$(document).on("keypress", "#search-field", function(e){

		if(e.keyCode == 13)
		{
			e.preventDefault();

			if(!hasMouse)
			{
				$("#search-field").blur();
				doSearch($("#search-field").val());
			}
		}
	});

	$(document).on("keyup", "#search-field", function(e){

		if(lastSearch !== $("#search-field").val() && hasMouse)
			doSearch($("#search-field").val());
	});

	$(document).on("click", "#close-search", function(){
		closeSearch()
	});


	// Handle keyboard navigation

    $(document).keydown(function(e) {
		switch(e.keyCode) {
			case 27:
				// ESC
				e.preventDefault();

				if($html.is(".search-open"))
					closeSearch();
				else if($html.is(".overlay-open"))
					closeOverlay();

			break;
        }
    });


	// Toggle main video sound

	$(document).on("click", "#toggle-sound", function(){
		var $button = $(this);
		var $video = $("#main-header").find("video");

		if($video.length)
		{
			if($button.is(".mute"))
			{
				$button.removeClass("mute");
				$video[0].muted = true;
			}
			else
			{
				$button.addClass("mute");
				$video[0].muted = false;
			}
		}
	});


	// Cookies popup

	var cookiesAccepted = Cookies.get(window.websiteID + '_cookiesAccepted');

	if(!cookiesAccepted)
	{
		$("#cookies-popup").addClass("show-cookies");
	}

	$(document).on("click", "#close-popup", function(){
		Cookies.set(window.websiteID + '_cookiesAccepted', '1', { expires: 7 });

		$.Velocity.animate($("#cookies-popup"), { translateY: [$("#cookies-popup").outerHeight() + 15, 0], translateZ: 0 }, { duration: slideDuration*3/4, easing: slideEasing }).then(function(){
			$("#cookies-popup").empty().remove();
		});
	});

	// Load non-slider images

	$("#main-header, #profile-header").fixObjectFit()
	$("#main-header, #profile-header, #thumbs").lazyLoad();
	
	
	// Download buttons
	$(document).on("click", ".download.button", function(e){

		e.preventDefault();
		var $button = $(this);

		if(!$button.is(".working"))
		{
			$button.addClass("working");

			// Call PDF download
			printPdf(this);
		}
	});
});

$(window).on("load", function(){
	pageLoaded = true;

	$("html").addClass("page-loaded");
});

$(window).on("beforeunload", function(){
	$("body").attr("style", "opacity:0");
	$(window).scrollTop(0);
});



uiPostRequestCallback = function(params, millis) {


	$(document).on("change keyup", "#uploads-field-1,#uploads-field-2,#uploads-field-3", function(){
		var $input = $(this);
		var filelist = this.files || [];
		var id = $input.attr("id").replace("uploads-field-", "");

		if(filelist.length)
		{
			var text = filelist[0].name;

			$("#uploads-wrapper-" + id).addClass("valid");
			$("#uploads-text-" + id).text(text);
		}
		else
		{
			$("#uploads-wrapper-" + id).removeClass("valid");
			$("#uploads-text-" + id).text($("#uploads-text-" + id).attr("data-text"));
		}
	});


	 // Change this to the location of your server-side upload handler:
    // var url = window.location.hostname === '/upload-support.app';
	var url = '/upload-support.app';

    $('#uploads-field-1').fileupload({
        url: url,
        dropZone: $('#uploads-field-1'),
        done: function (e, data) {
        	console.log("FILE 1 OK");
        	console.log(e);
        	console.log(data);

        	$.each(data.files, function (index, file) {
                $('#uploads-text-1').text(file.name);
            });
        }
    }).prop('disabled', !$.support.fileInput)


    $('#uploads-field-2').fileupload({
        url: url,
        dropZone: $('#uploads-field-2'),
        done: function (e, data) {
        	console.log("FILE 2 OK");
        	console.log(e);
        	console.log(data);

        	$.each(data.files, function (index, file) {
        		$('#uploads-text-2').text(file.name);
            });
        }
    }).prop('disabled', !$.support.fileInput)

    $('#uploads-field-3').fileupload({
        url: url,
        dropZone: $('#uploads-field-3'),
        done: function (e, data) {
        	console.log("FILE 3 OK");
        	console.log(e);
        	console.log(data);

        	$.each(data.files, function (index, file) {
        		$('#uploads-text-3').text(file.name);
            });
        }
    }).prop('disabled', !$.support.fileInput)


}



function checkForm(form){


	$('#file-error').hide();

	$('#waiting').removeClass('hide');

	var genre = $('input[name="genreOption"]:checked').val();

	$('#genre').val(genre);

    // avoid multiple submit
    $('.send').attr('disabled','disabled');
    $('.send').css('opacity','0.3');

    /*
    if(!checkFile('#fileupload1') || !checkFile('#fileupload2') || !checkFile('#fileupload3')){
    	$('#file-error').show();
    	$('#waiting').addClass('hide');
    	return;
    }
    */

    setTimeout(function(){
  	  $('.send').removeAttr('disabled');
  	  $('.send').css('opacity','1');
    },5000);

    console.log("submission starts");

    return uif(form);

}

function toggleTerms(){
	if($('#termsBox').css('display') == 'none'){
		$('#termsBox').slideDown();
	}else{
		$('#termsBox').slideUp();
	}
}

function initializeFileUpload(){

	 var url = '/upload-support.app';

	    $('#uploads-field-1').fileupload({
	        url: url,
	        dropZone: $('#uploads-field-1'),
	        done: function (e, data) {
	        	console.log("FILE 1 ok");
	        	console.log(e);
	        	console.log(data);
	        	$.each(data.files, function (index, file) {
	                $(e.target).siblings('.uploads-text').text(file.name);
	            });
	        }
	    }).prop('disabled', !$.support.fileInput)

	    $('#uploads-field-2').fileupload({
	        url: url,
	        dropZone: $('#uploads-field-2'),
	        done: function (e, data) {
	        	console.log("FILE 2 ok");
	        	console.log(e);
	        	console.log(data);
	        	$.each(data.files, function (index, file) {
	                $(e.target).siblings('.uploads-text').text(file.name);
	            });
	        }
	    }).prop('disabled', !$.support.fileInput)

	    $('#uploads-field-3').fileupload({
	        url: url,
	        dropZone: $('#uploads-field-3'),
	        done: function (e, data) {
	        	console.log("FILE 3 ok");
	        	console.log(e);
	        	console.log(data);
	        	$.each(data.files, function (index, file) {
	                $(e.target).siblings('.uploads-text').text(file.name);
	            });
	        }
	    }).prop('disabled', !$.support.fileInput)

}

function printPdf(elem){

	var talentId = $(elem).data('talentid');
	var urlToPrint = $(elem).data('urltoprint');
	var fileName = $(elem).data('filename');

	console.log(talentId);
	console.log(urlToPrint);
	console.log(window.location.origin + urlToPrint);
	console.log(fileName);

	var pdfDownloadUrl = 'https://print.womenmanagement.net';


	// TO TEST
	// pdfDownloadUrl = 'http://nodejs.finelab.marilyn.crazymage.fr';
	// urlToPrint = 'https://it.wikipedia.org/wiki/Lorem_ipsum';

	var params = {
		shuffleID: talentId,
		format: 1,
		url: window.location.origin + urlToPrint
	};


	$.ajax({
  		type: "POST",
		url: pdfDownloadUrl + "/pdf/print",
  		data: params,
  		dataType: "json",
  		success: function(e){
  			if (e.id) {
					r = talentId;
					var windowWidth = $(window).width();

                var t = "WOMEN MANAGEMENT",
                    i = fileName,
                    a = document.createElement("iframe"),
                    o = document.createAttribute("class"),
                    s = r;


					var IS_MOBILE = false;
					if(windowWidth < 768){
						IS_MOBILE = true;
					}

                IS_MOBILE ? s = "_blank" : (o.value = "iframedownload", a.id = r, a.setAttributeNode(o), a.name = r, a.style = "visibility:hidden;display:none;", document.body.appendChild(a)), $("body").append('<form style="display:none;" action="' + pdfDownloadUrl + '/pdf/download" method="post" target="' + s + '" id="postToIframe"></form>');
                var n = '<input type="hidden" name="id" value="' + r + '" />';
                n += '<input type="hidden" name="name" value="' + i + '" />', $("#postToIframe").append(n), $("#postToIframe").submit().remove()

					 console.log("submit effettuata");

            }

			$(elem).removeClass("working");
  		},
  		error: function(){
    		alert("Something was wrong. Please try again.");
    		$(elem).removeClass("working");
  		}

    });


}
